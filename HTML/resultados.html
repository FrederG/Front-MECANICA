<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Resultados - Mec√°nica de Fluidos</title>
    <!-- Incluye solo el archivo style.css con todo el contenido unificado -->
    <link rel="stylesheet" href="/css/style.css">
    <script src="resultados.js"></script>
    <script src="app.js"></script>
</head>

<body>
    <!-- üß† Header -->
    <header>
        <div class="logo-container">
            <img src="https://upload.wikimedia.org/wikipedia/commons/b/b3/Universidad_Tecnol%C3%B3gica_de_Bol%C3%ADvar.png"
                alt="Logo" class="logo">
            <h1>üìä Resultados de los Ejercicios</h1>
        </div>

        <nav>
            <a href="login.html">Inicio</a>
            <a href="ejercicios.html">Ejercicios</a>
            <a href="resultados.html" class="active">Resultados</a>
            <a href="login.html#Acerca">Acerca de</a>
        </nav>
        <button class="btn-logout" onclick="cerrarSesion()">Cerrar sesi√≥n</button> ¬† ¬† ¬†
    </header>

    <!-- üß© Contenido principal -->
    <main>
        <section class="contenedor-resultados">
            
            <h2>Historial de Desempe√±o</h2>
            <p>Aqu√≠ puedes visualizar tu historial completo de resultados y puntajes.</p>

            <!-- Contenedor del puntaje total -->
            <div id="puntajeUsuarioDisplay" class="puntaje-total-display">
                Cargando puntaje total...
            </div>
            
            <!-- Bot√≥n de acci√≥n -->
            <button onclick="eliminarTodos()" class="btn-accion btn-eliminar-todo">
                üßπ Eliminar todos los resultados (Local)
            </button>
            <section>
                <script>
                    // Funci√≥n para cargar resultados desde el servidor
async function cargarResultados() {
    try {
        const response = await fetch("https://backend-fluidos-production.up.railway.app/resultados_db/");
        const data = await response.json();

        const tbody = document.querySelector("#tablaResultados tbody");
        tbody.innerHTML = ""; // Limpia antes de insertar

        if (data.resultados.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6">No hay resultados registrados</td></tr>';
            return;
        }

        data.resultados.forEach(r => {
            const row = document.createElement("tr");
            
            // Formatear la respuesta para que sea m√°s legible
            let respuestaFormateada = r.respuesta;
            
            // Si es el ejercicio 6 o 10 (m√∫ltiples respuestas), intentar formatear como JSON
            if (r.ejercicio === 6 || r.ejercicio === 10) {
                try {
                    const respuestasMultiples = JSON.parse(r.respuesta);
                    respuestaFormateada = Object.entries(respuestasMultiples)
                        .map(([key, value]) => 
                            `${key.toUpperCase()}: ${value.valor} ${value.unidad || ''}`
                        )
                        .join('<br>');
                } catch (e) {
                    // Si no es JSON v√°lido, mostrar como texto normal
                    respuestaFormateada = r.respuesta;
                }
            }

            row.innerHTML = `
                <td>${r.usuario}</td>
                <td>${r.ejercicio}</td>
                <td class="respuesta-cell">${respuestaFormateada}</td>
                <td>${r.puntaje}</td>
                <td class="estado-cell">
                    <span class="estado-indicador" style="background-color:${r.color === 'green' ? '#2ecc71' : r.color === 'yellow' ? '#f39c12' : '#e74c3c'}"></span>
                    ${r.color === 'green' ? '‚úÖ Correcto' : r.color === 'yellow' ? 'üü° Parcial' : '‚ùå Incorrecto'}
                </td>
                <td>${new Date(r.fecha).toLocaleString()}</td>
            `;
            tbody.appendChild(row);
        });
    } catch (error) {
        console.error("‚ùå Error al cargar los resultados:", error);
        const tbody = document.querySelector("#tablaResultados tbody");
        tbody.innerHTML = '<tr><td colspan="6">‚ùå Error al cargar los resultados desde el servidor</td></tr>';
    }
}

// Funci√≥n para eliminar un resultado espec√≠fico
async function eliminarResultado(id) {
    if (!confirm("¬øSeguro que deseas eliminar este resultado?")) return;

    try {
        const response = await fetch(`https://backend-fluidos-production.up.railway.app/eliminar_resultado/${id}`, {
            method: "DELETE"
        });

        const data = await response.json();
        alert(data.mensaje);
        cargarResultados(); // recarga la tabla
    } catch (error) {
        console.error("‚ùå Error al eliminar resultado:", error);
        alert("Error al eliminar el resultado");
    }
}

// Funci√≥n para eliminar todos los resultados
async function eliminarTodos() {
    if (!confirm("‚ö†Ô∏è Esto borrar√° todos los resultados del servidor. ¬øEst√°s seguro?")) return;

    try {
        const response = await fetch("https://backend-fluidos-production.up.railway.app/eliminar_todos/", {
            method: "DELETE"
        });

        const data = await response.json();
        alert(data.mensaje);
        cargarResultados(); // recarga la tabla
    } catch (error) {
        console.error("‚ùå Error al eliminar todos los resultados:", error);
        alert("Error al eliminar los resultados");
    }
}

// Funci√≥n para mostrar el puntaje total del usuario logueado
async function mostrarPuntajeUsuario() {
    const usuario = localStorage.getItem("usuarioActivo");
    const display = document.getElementById("puntajeUsuarioDisplay");
    
    if (!usuario) {
        display.textContent = "‚ö†Ô∏è No hay usuario activo. Inicia sesi√≥n para ver tu puntaje.";
        display.className = "puntaje-total-display error";
        return;
    }

    try {
        const res = await fetch(`https://backend-fluidos-production.up.railway.app/puntaje_total/${usuario}`);
        const data = await res.json();

        display.textContent = `üéØ Puntaje total de ${data.usuario}: ${data.puntaje_total} puntos`;
        display.className = "puntaje-total-display exito";
    } catch (error) {
        console.error("‚ùå Error al obtener puntaje:", error);
        display.textContent = "‚ùå Error al conectar con el servidor";
        display.className = "puntaje-total-display error";
    }
}

// Cargar resultados cuando se carga la p√°gina
document.addEventListener("DOMContentLoaded", function() {
    cargarResultados();
    mostrarPuntajeUsuario();
});

// Tambi√©n cargar al hacer load por si acaso
window.addEventListener("load", function() {
    cargarResultados();
    mostrarPuntajeUsuario();
});
                </script>
            </section>
            <!-- Contenedor de la tabla responsive -->
            <div class="tabla-container">
                <table id="tablaResultados" class="tabla-resultados">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Ejercicio</th>
                            <th>Respuesta</th>
                            <th>Puntaje</th>
                            <th>Estado</th>
                            <th>Fecha</th>
                        </tr>
                    </thead>
                    <!-- El cuerpo se llena con JavaScript -->
                    <tbody>
                        <tr><td colspan="6">Cargando datos...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- ü¶∂ Footer -->
    <footer>
        <p>¬© 2025 Proyecto Mec√°nica de Fluidos - UTB</p>
    </footer>
</body>
</html>